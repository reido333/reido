<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Checklist Privado</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #e9ecef; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="date"] { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        #addBtn { background: #007bff; color: white; }
        #googleLoginBtn { background: #db4437; color: white; margin-bottom: 15px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
        ul { list-style: none; padding: 0; }
        li { background: #fff; border-bottom: 1px solid #eee; padding: 12px; display: flex; align-items: center; gap: 10px; }
        .task-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .date-badge { font-size: 0.8em; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; }
        .done span { text-decoration: line-through; opacity: 0.5; }
        .delete-btn { background: none; color: #ff4d4d; font-size: 18px; padding: 0 5px; cursor: pointer; }
        .delete-btn:hover { color: #cc0000; }
        #loading { text-align: center; color: #666; font-style: italic; }
        .user-info { font-size: 0.8em; color: #888; text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h2>üìù Meu Checklist</h2>
    <div id="loading">Carregando...</div>
    <div id="authSection" style="display: none;"><button id="googleLoginBtn">Salvar com Google</button></div>
    <div id="mainContent" style="display: none;">
        <div id="userInfo" class="user-info"></div>
        <div class="form-group">
            <input type="text" id="taskInput" placeholder="O que precisa ser feito?">
            <input type="date" id="dateInput">
            <button id="addBtn">Adicionar Tarefa</button>
        </div>
        <ul id="taskList"></ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAL4ySdfSAADCvtcjDUOXPEJVAIFupu9P8",
        authDomain: "reido-f92ee.firebaseapp.com",
        projectId: "reido-f92ee",
        storageBucket: "reido-f92ee.firebasestorage.app",
        messagingSenderId: "168960472442",
        appId: "1:168960472442:web:32d61e9659bb8c043f92c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colRef = collection(db, "tarefas");

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('authSection').style.display = user.isAnonymous ? 'block' : 'none';
            document.getElementById('userInfo').innerHTML = `Logado como: <b>${user.displayName || 'Convidado'}</b>`;
            startListening(user.uid);
        } else {
            signInAnonymously(auth);
        }
    });

    document.getElementById('googleLoginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    document.getElementById('addBtn').onclick = async () => {
        const text = document.getElementById('taskInput').value;
        const date = document.getElementById('dateInput').value;
        if (text && date) {
            await addDoc(colRef, { text, date, completed: false, userId: auth.currentUser.uid, createdAt: Date.now() });
            document.getElementById('taskInput').value = '';
        }
    };

    function startListening(uid) {
        const q = query(colRef, where("userId", "==", uid), orderBy("date", "asc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            snap.forEach(d => {
                const t = d.data();
                const li = document.createElement('li');
                if (t.completed) li.classList.add('done');
                li.innerHTML = `
                    <div class="task-info">
                        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="this.dispatchEvent(new CustomEvent('toggle', {detail: '${d.id}'}))">
                        <span>${t.text}</span>
                    </div>
                    <span class="date-badge">${t.date.split('-').reverse().join('/')}</span>
                    <button class="delete-btn" onclick="this.dispatchEvent(new CustomEvent('delete', {detail: '${d.id}'}))">‚úñ</button>
                `;
                // Eventos de clique
                li.querySelector('input').addEventListener('toggle', (e) => updateDoc(doc(db, "tarefas", e.detail), { completed: !t.completed }));
                li.querySelector('.delete-btn').addEventListener('delete', (e) => { if(confirm('Excluir tarefa?')) deleteDoc(doc(db, "tarefas", e.detail)); });
                list.appendChild(li);
            });
        });
    }
</script>
</body>
</html>
